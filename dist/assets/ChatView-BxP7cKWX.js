import{H as E,_ as N,r as o,C,A as d,z as B,I as i,J as L,c as v,a as n,l as k,b as V,F as W,i as A,d as D,v as K,K as P,w as H,M as F,o as l,E as J,h as w,t as b,N as O,L as U}from"./index-BXw2fPDX.js";import{g as z,a as R,b as G,u as X}from"./fcmService-DzY3untW.js";const Y=async()=>{try{return await E("GET","/admin-info")}catch(f){throw f}},$={class:"client-chat-view"},j={class:"chat-container"},q={class:"chat-panel"},Q={key:0,class:"error-banner"},Z={class:"message-content pre-line-text"},ee={class:"message-timestamp"},te={class:"chat-input-area"},ae=["onKeydown"],se=["disabled"],ne={__name:"ChatView",setup(f){const h=o([]),r=o(""),a=o(null),g=o(null),c=o(null),u=o(!1),m=o(!1),p=o(null),_=()=>{F(()=>{c.value&&(c.value.scrollTop=c.value.scrollHeight)})},M=async()=>{try{const e=R(),t=await G(e,{vapidKey:"BMJYrDhHREPAVJuzDYrBQb6APXLLy4KEGMMds0SMf-PtNIAS9-lnPOmoXlbVi00w2hhAjgO8CxW8BnmRDhHMx3w"});t?await X(t):console.log("No registration token available. Request permission to generate one.")}catch(e){console.error("An error occurred while retrieving token. ",e)}},I=()=>{if(!i.value){u.value=!0;return}const e=i.value.startsWith("Bearer ")?i.value.substring(7):i.value,t=`${O()}?token=${e}`;a.value=new WebSocket(t),a.value.onopen=()=>{u.value=!1},a.value.onmessage=s=>{const T=JSON.parse(s.data);h.value.push(T),_()},a.value.onclose=()=>console.log("WebSocket disconnected"),a.value.onerror=s=>{u.value=!0}},y=()=>{if(r.value.trim()===""||!a.value||!g.value||a.value.readyState!==WebSocket.OPEN)return;const e={content:r.value,receiverId:g.value.id};a.value.send(JSON.stringify(e)),r.value="",_(),p.value&&(p.value.style.height="auto")},S=e=>e?new Date(e).toLocaleString("vi-VN",{hour:"2-digit",minute:"2-digit"}):"",x=e=>{e.target.style.height="auto",e.target.style.height=e.target.scrollHeight+"px"};return C(async()=>{if(m.value=!0,d.value||await B(),!(!i.value||!d.value))try{const[e,t]=await Promise.all([z(),Y()]);h.value=e||[],g.value=t,m.value=!1,_(),I(),M()}catch(e){console.error("Failed to load chat data:",e)}}),L(()=>{a.value&&a.value.close()}),(e,t)=>(l(),v("div",$,[n("div",j,[n("div",q,[t[1]||(t[1]=n("div",{class:"chat-header"},"TUNI shop",-1)),u.value?(l(),v("div",Q," Không thể kết nối tới máy chủ chat. Vui lòng thử lại sau. ")):k("",!0),m.value?(l(),V(U,{key:1,message:"Đang tải tin nhắn..."})):k("",!0),n("div",{class:"message-list",ref_key:"messageListEl",ref:c},[(l(!0),v(W,null,A(h.value,s=>(l(),v("div",{key:s.ID||s.timestamp,class:J(["message-item",w(d)&&s.senderId===w(d).id?"sent":"received"])},[n("div",Z,b(s.content),1),n("div",ee,b(S(s.timestamp)),1)],2))),128))],512),n("div",te,[D(n("textarea",{ref_key:"chatInputEl",ref:p,class:"chat-input",placeholder:"Nhập tin nhắn...","onUpdate:modelValue":t[0]||(t[0]=s=>r.value=s),onKeydown:P(H(y,["prevent","exact"]),["enter"]),rows:"1",onInput:x},"                    ",40,ae),[[K,r.value]]),n("button",{class:"btn-primary",onClick:y,disabled:!r.value.trim()},"Gửi",8,se)])])])]))}},ie=N(ne,[["__scopeId","data-v-847ade0c"]]);export{ie as default};
