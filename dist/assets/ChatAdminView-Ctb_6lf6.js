import{r as i,B as H,h as g,z as K,a2 as m,a0 as O,a3 as P,c as u,d as t,f as C,F as S,j as L,t as k,m as I,g as U,v as $,a4 as z,w as J,D as N,a5 as R,a6 as j,a7 as X,a8 as Y,o as r,e as B,a9 as q,aa as G,ab as Q,L as T}from"./index-Cj_2ZRkI.js";const Z={class:"user-list-panel"},ee={class:"user-list"},se=["onClick"],ae={class:"username"},te={key:0,class:"new-message-indicator"},ne={class:"chat-panel"},oe={class:"chat-header"},le={class:"message-content pre-line-text"},ie={class:"message-timestamp"},re={class:"chat-input-area"},ce=["placeholder","onKeydown"],ue=["disabled"],he={__name:"ChatAdminView",setup(de){const v=i([]),n=i(null),h=i([]),d=i(""),l=i(null),f=i(null),w=i(!1),_=i(!1),y=i(null),p=i(!1),M=()=>{q(()=>{f.value&&(f.value.scrollTop=f.value.scrollHeight)})},W=async s=>{var a;if(!(((a=n.value)==null?void 0:a.id)===s.id&&p.value)){n.value=s,p.value=!0,h.value=[],w.value=!0;try{const e=await G(s.id);h.value=e||[];const o=v.value.find(c=>c.id===s.id);o&&(o.hasNewMessage=!1),M()}catch(e){console.error(`Failed to load chat history for user ${s.id}:`,e)}finally{w.value=!1}}},D=()=>{p.value=!1},E=async()=>{try{const s=R(),a=await j(s,{vapidKey:"BMJYrDhHREPAVJuzDYrBQb6APXLLy4KEGMMds0SMf-PtNIAS9-lnPOmoXlbVi00w2hhAjgO8CxW8BnmRDhHMx3w"});a?await X(a):console.log("No registration token available. Request permission to generate one."),Y(s,e=>{console.log("Message received. ",e);const o=parseInt(e.data.sender_id);if(o&&(!n.value||n.value.id!==o)){const c=v.value.find(b=>b.id===o);c&&(c.hasNewMessage=!0)}})}catch(s){console.error("An error occurred while retrieving token. ",s)}},V=()=>{if(!m.value)return;const s=m.value.startsWith("Bearer ")?m.value.substring(7):m.value,a=`${Q()}?token=${s}`;l.value=new WebSocket(a),l.value.onopen=()=>console.log("WebSocket connected"),l.value.onmessage=e=>{const o=JSON.parse(e.data);if(n.value&&o.senderId===n.value.id)h.value.push(o),M();else{const c=v.value.find(b=>b.id===o.senderId);c&&(c.hasNewMessage=!0)}},l.value.onclose=()=>console.log("WebSocket disconnected"),l.value.onerror=e=>console.error("WebSocket error:",e)},x=()=>{if(d.value.trim()===""||!l.value||!n.value||l.value.readyState!==WebSocket.OPEN)return;const s={content:d.value,receiverId:n.value.id};l.value.send(JSON.stringify(s)),h.value.push({...s,senderId:g.value.id,timestamp:new Date().toISOString()}),d.value="",M(),y.value&&(y.value.style.height="auto")},A=s=>s?new Date(s).toLocaleString("vi-VN",{hour:"2-digit",minute:"2-digit"}):"",F=s=>{s.target.style.height="auto",s.target.style.height=s.target.scrollHeight+"px"};return H(async()=>{var s;if(_.value=!0,g.value||await K(),!(!m.value||!((s=g.value)!=null&&s.admin)))try{const a=await O();v.value=a.filter(e=>!e.admin).map(e=>({...e,hasNewMessage:!1})),_.value=!1,V(),E()}catch(a){console.error("Failed to load users:",a)}}),P(()=>{l.value&&l.value.close()}),(s,a)=>(r(),u("div",{class:N(["chat-container",{"show-chat":p.value}])},[t("div",Z,[a[1]||(a[1]=t("div",{class:"user-list-header"},"Khách hàng",-1)),t("div",ee,[_.value?(r(),C(T,{key:0,message:"Đang tải..."})):(r(!0),u(S,{key:1},L(v.value,e=>(r(),u("div",{key:e.id,class:N(["user-item",{active:n.value&&n.value.id===e.id}]),onClick:o=>W(e)},[t("span",ae,k(e.username||e.email),1),e.hasNewMessage?(r(),u("span",te)):I("",!0)],10,se))),128))])]),t("div",ne,[n.value?(r(),u(S,{key:0},[t("div",oe,[t("button",{class:"back-button",onClick:D},a[2]||(a[2]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15.75 19.5 8.25 12l7.5-7.5"})],-1)])),t("span",null,"Nhắn tin với "+k(n.value.username||n.value.email),1)]),t("div",{class:"message-list",ref_key:"messageListEl",ref:f},[w.value?(r(),C(T,{key:0,message:"Đang tải lịch sử..."})):I("",!0),(r(!0),u(S,null,L(h.value,e=>(r(),u("div",{key:e.ID||e.timestamp,class:N(["message-item",B(g)&&e.senderId===B(g).id?"sent":"received"])},[t("div",le,k(e.content),1),t("div",ie,k(A(e.timestamp)),1)],2))),128))],512),t("div",re,[U(t("textarea",{class:"chat-input",placeholder:`Nhắn tin cho ${n.value.username}`,"onUpdate:modelValue":a[0]||(a[0]=e=>d.value=e),onKeydown:z(J(x,["prevent","exact"]),["enter"]),rows:"1",onInput:F,ref_key:"chatInputEl",ref:y},"                    ",40,ce),[[$,d.value]]),t("button",{class:"send-btn",onClick:x,disabled:!d.value.trim()},a[3]||(a[3]=[t("i",{class:"fa-solid fa-paper-plane"},null,-1)]),8,ue)])],64)):I("",!0)])],2))}};export{he as default};
