import{r as i,B as A,C as g,z as K,D as m,a0 as O,E as P,c as u,a,b as x,F as S,i as L,t as k,l as I,d as U,v as J,G as $,w as z,I as C,o as r,h as B,H as R,J as G,L as T}from"./index-DqITul0o.js";import{a as j,b as X,u as Y,o as q,g as Q}from"./fcmService-BoVVeO3n.js";const Z={class:"user-list-panel"},ee={class:"user-list"},se=["onClick"],te={class:"username"},ae={key:0,class:"new-message-indicator"},oe={class:"chat-panel"},ne={class:"chat-header"},le={class:"message-content pre-line-text"},ie={class:"message-timestamp"},re={class:"chat-input-area"},ce=["placeholder","onKeydown"],ue=["disabled"],ge={__name:"ChatAdminView",setup(de){const v=i([]),o=i(null),h=i([]),d=i(""),l=i(null),f=i(null),w=i(!1),_=i(!1),y=i(null),p=i(!1),M=()=>{R(()=>{f.value&&(f.value.scrollTop=f.value.scrollHeight)})},W=async s=>{var t;if(!(((t=o.value)==null?void 0:t.id)===s.id&&p.value)){o.value=s,p.value=!0,h.value=[],w.value=!0;try{const e=await Q(s.id);h.value=e||[];const n=v.value.find(c=>c.id===s.id);n&&(n.hasNewMessage=!1),M()}catch(e){console.error(`Failed to load chat history for user ${s.id}:`,e)}finally{w.value=!1}}},D=()=>{p.value=!1},E=async()=>{try{const s=j(),t=await X(s,{vapidKey:"BMJYrDhHREPAVJuzDYrBQb6APXLLy4KEGMMds0SMf-PtNIAS9-lnPOmoXlbVi00w2hhAjgO8CxW8BnmRDhHMx3w"});t?(console.log("FCM registration token:",t),await Y(t)):console.log("No registration token available. Request permission to generate one."),q(s,e=>{console.log("Message received. ",e);const n=parseInt(e.data.sender_id);if(n&&(!o.value||o.value.id!==n)){const c=v.value.find(b=>b.id===n);c&&(c.hasNewMessage=!0)}})}catch(s){console.error("An error occurred while retrieving token. ",s)}},V=()=>{if(!m.value)return;const s=m.value.startsWith("Bearer ")?m.value.substring(7):m.value,t=`${G()}?token=${s}`;l.value=new WebSocket(t),l.value.onopen=()=>console.log("WebSocket connected"),l.value.onmessage=e=>{const n=JSON.parse(e.data);if(o.value&&n.senderId===o.value.id)h.value.push(n),M();else{const c=v.value.find(b=>b.id===n.senderId);c&&(c.hasNewMessage=!0)}},l.value.onclose=()=>console.log("WebSocket disconnected"),l.value.onerror=e=>console.error("WebSocket error:",e)},N=()=>{if(d.value.trim()===""||!l.value||!o.value||l.value.readyState!==WebSocket.OPEN)return;const s={content:d.value,receiverId:o.value.id};l.value.send(JSON.stringify(s)),h.value.push({...s,senderId:g.value.id,timestamp:new Date().toISOString()}),d.value="",M(),y.value&&(y.value.style.height="auto")},F=s=>s?new Date(s).toLocaleString("vi-VN",{hour:"2-digit",minute:"2-digit"}):"",H=s=>{s.target.style.height="auto",s.target.style.height=s.target.scrollHeight+"px"};return A(async()=>{var s;if(_.value=!0,g.value||await K(),!(!m.value||!((s=g.value)!=null&&s.admin)))try{const t=await O();v.value=t.filter(e=>!e.admin).map(e=>({...e,hasNewMessage:!1})),_.value=!1,V(),E()}catch(t){console.error("Failed to load users:",t)}}),P(()=>{l.value&&l.value.close()}),(s,t)=>(r(),u("div",{class:C(["chat-container",{"show-chat":p.value}])},[a("div",Z,[t[1]||(t[1]=a("div",{class:"user-list-header"},"Khách hàng",-1)),a("div",ee,[_.value?(r(),x(T,{key:0,message:"Đang tải..."})):(r(!0),u(S,{key:1},L(v.value,e=>(r(),u("div",{key:e.id,class:C(["user-item",{active:o.value&&o.value.id===e.id}]),onClick:n=>W(e)},[a("span",te,k(e.username||e.email),1),e.hasNewMessage?(r(),u("span",ae)):I("",!0)],10,se))),128))])]),a("div",oe,[o.value?(r(),u(S,{key:0},[a("div",ne,[a("button",{class:"back-button",onClick:D},t[2]||(t[2]=[a("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15.75 19.5 8.25 12l7.5-7.5"})],-1)])),a("span",null,"Nhắn tin với "+k(o.value.username||o.value.email),1)]),a("div",{class:"message-list",ref_key:"messageListEl",ref:f},[w.value?(r(),x(T,{key:0,message:"Đang tải lịch sử..."})):I("",!0),(r(!0),u(S,null,L(h.value,e=>(r(),u("div",{key:e.ID||e.timestamp,class:C(["message-item",B(g)&&e.senderId===B(g).id?"sent":"received"])},[a("div",le,k(e.content),1),a("div",ie,k(F(e.timestamp)),1)],2))),128))],512),a("div",re,[U(a("textarea",{class:"chat-input",placeholder:`Nhắn tin cho ${o.value.username}`,"onUpdate:modelValue":t[0]||(t[0]=e=>d.value=e),onKeydown:$(z(N,["prevent","exact"]),["enter"]),rows:"1",onInput:H,ref_key:"chatInputEl",ref:y},"                    ",40,ce),[[J,d.value]]),a("button",{class:"btn-primary",onClick:N,disabled:!d.value.trim()},"Gửi",8,ue)])],64)):I("",!0)])],2))}};export{ge as default};
