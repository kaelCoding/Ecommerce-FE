import{G as B,_ as E,r as o,B as N,g as d,z as C,H as i,I as L,c as v,b as n,m as k,d as V,F as D,j as W,e as K,v as P,J as A,w as H,K as F,o as l,D as J,i as w,t as b,M as O,L as U}from"./index-aK0Jjgsl.js";import{g as z,a as G,b as R,u as j}from"./fcmService-BumcjAnN.js";const X=async()=>{try{return await B("GET","/admin-info")}catch(f){throw f}},Y={class:"client-chat-view"},$={class:"chat-container"},q={class:"chat-panel"},Q={key:0,class:"error-banner"},Z={class:"message-content pre-line-text"},ee={class:"message-timestamp"},te={class:"chat-input-area"},ae=["onKeydown"],se=["disabled"],ne={__name:"ChatView",setup(f){const h=o([]),r=o(""),a=o(null),g=o(null),c=o(null),u=o(!1),m=o(!1),p=o(null),_=()=>{F(()=>{c.value&&(c.value.scrollTop=c.value.scrollHeight)})},M=async()=>{try{const e=G(),t=await R(e,{vapidKey:"BMJYrDhHREPAVJuzDYrBQb6APXLLy4KEGMMds0SMf-PtNIAS9-lnPOmoXlbVi00w2hhAjgO8CxW8BnmRDhHMx3w"});t?await j(t):console.log("No registration token available. Request permission to generate one.")}catch(e){console.error("An error occurred while retrieving token. ",e)}},I=()=>{if(!i.value){u.value=!0;return}const e=i.value.startsWith("Bearer ")?i.value.substring(7):i.value,t=`${O()}?token=${e}`;a.value=new WebSocket(t),a.value.onopen=()=>{u.value=!1},a.value.onmessage=s=>{const T=JSON.parse(s.data);h.value.push(T),_()},a.value.onclose=()=>console.log("WebSocket disconnected"),a.value.onerror=s=>{u.value=!0}},y=()=>{if(r.value.trim()===""||!a.value||!g.value||a.value.readyState!==WebSocket.OPEN)return;const e={content:r.value,receiverId:g.value.id};a.value.send(JSON.stringify(e)),r.value="",_(),p.value&&(p.value.style.height="auto")},S=e=>e?new Date(e).toLocaleString("vi-VN",{hour:"2-digit",minute:"2-digit"}):"",x=e=>{e.target.style.height="auto",e.target.style.height=e.target.scrollHeight+"px"};return N(async()=>{if(m.value=!0,d.value||await C(),!(!i.value||!d.value))try{const[e,t]=await Promise.all([z(),X()]);h.value=e||[],g.value=t,m.value=!1,_(),I(),M()}catch(e){console.error("Failed to load chat data:",e)}}),L(()=>{a.value&&a.value.close()}),(e,t)=>(l(),v("div",Y,[n("div",$,[n("div",q,[t[1]||(t[1]=n("div",{class:"chat-header"},"TUNI shop",-1)),u.value?(l(),v("div",Q," Không thể kết nối tới máy chủ chat. Vui lòng thử lại sau. ")):k("",!0),m.value?(l(),V(U,{key:1,message:"Đang tải tin nhắn..."})):k("",!0),n("div",{class:"message-list",ref_key:"messageListEl",ref:c},[(l(!0),v(D,null,W(h.value,s=>(l(),v("div",{key:s.ID||s.timestamp,class:J(["message-item",w(d)&&s.senderId===w(d).id?"sent":"received"])},[n("div",Z,b(s.content),1),n("div",ee,b(S(s.timestamp)),1)],2))),128))],512),n("div",te,[K(n("textarea",{ref_key:"chatInputEl",ref:p,class:"chat-input",placeholder:"Nhập tin nhắn...","onUpdate:modelValue":t[0]||(t[0]=s=>r.value=s),onKeydown:A(H(y,["prevent","exact"]),["enter"]),rows:"1",onInput:x},"                    ",40,ae),[[P,r.value]]),n("button",{class:"btn-primary",onClick:y,disabled:!r.value.trim()},"Gửi",8,se)])])])]))}},ie=E(ne,[["__scopeId","data-v-847ade0c"]]);export{ie as default};
