import{r as o,B as $,h as v,z as F,a2 as h,a0 as H,a3 as K,c as u,d as t,e as L,F as S,k as C,j as N,t as k,g as O,v as z,a4 as j,w as J,D as x,a5 as P,a6 as A,o as i,f as M,a7 as R,L as B}from"./index-DFV4gWia.js";const q={class:"user-list-panel"},G={class:"user-list"},Q=["onClick"],X={class:"username"},Y={key:0,class:"new-message-indicator"},Z={class:"chat-panel"},ee={class:"chat-header"},se={class:"message-content pre-line-text"},ae={class:"message-timestamp"},te={class:"chat-input-area"},ne=["placeholder","onKeydown"],le=["disabled"],re={__name:"ChatAdminView",setup(oe){const g=o([]),n=o(null),d=o([]),c=o(""),l=o(null),m=o(null),_=o(!1),w=o(!1),y=o(null),f=o(!1),b=()=>{A(()=>{m.value&&(m.value.scrollTop=m.value.scrollHeight)})},T=async s=>{var a;if(!(((a=n.value)==null?void 0:a.id)===s.id&&f.value)){n.value=s,f.value=!0,d.value=[],_.value=!0;try{const e=await R(s.id);d.value=e||[];const r=g.value.find(p=>p.id===s.id);r&&(r.hasNewMessage=!1),b()}catch(e){console.error(`Failed to load chat history for user ${s.id}:`,e)}finally{_.value=!1}}},W=()=>{f.value=!1},D=()=>{if(!h.value)return;const s=h.value.startsWith("Bearer ")?h.value.substring(7):h.value,a=`${P()}?token=${s}`;l.value=new WebSocket(a),l.value.onopen=()=>console.log("WebSocket connected"),l.value.onmessage=e=>{const r=JSON.parse(e.data);if(n.value&&r.senderId===n.value.id)d.value.push(r),b();else{const p=g.value.find(V=>V.id===r.senderId);p&&(p.hasNewMessage=!0)}},l.value.onclose=()=>console.log("WebSocket disconnected"),l.value.onerror=e=>console.error("WebSocket error:",e)},I=()=>{if(c.value.trim()===""||!l.value||!n.value||l.value.readyState!==WebSocket.OPEN)return;const s={content:c.value,receiverId:n.value.id};l.value.send(JSON.stringify(s)),d.value.push({...s,senderId:v.value.id,timestamp:new Date().toISOString()}),c.value="",b(),y.value&&(y.value.style.height="auto")},E=s=>s?new Date(s).toLocaleString("vi-VN",{hour:"2-digit",minute:"2-digit"}):"",U=s=>{s.target.style.height="auto",s.target.style.height=s.target.scrollHeight+"px"};return $(async()=>{var s;if(w.value=!0,v.value||await F(),!(!h.value||!((s=v.value)!=null&&s.admin)))try{const a=await H();g.value=a.filter(e=>!e.admin).map(e=>({...e,hasNewMessage:!1})),w.value=!1,D()}catch(a){console.error("Failed to load users:",a)}}),K(()=>{l.value&&l.value.close()}),(s,a)=>(i(),u("div",{class:x(["chat-container",{"show-chat":f.value}])},[t("div",q,[a[1]||(a[1]=t("div",{class:"user-list-header"},"Khách hàng",-1)),t("div",G,[w.value?(i(),L(B,{key:0,message:"Đang tải..."})):(i(!0),u(S,{key:1},C(g.value,e=>(i(),u("div",{key:e.id,class:x(["user-item",{active:n.value&&n.value.id===e.id}]),onClick:r=>T(e)},[t("span",X,k(e.username||e.email),1),e.hasNewMessage?(i(),u("span",Y)):N("",!0)],10,Q))),128))])]),t("div",Z,[n.value?(i(),u(S,{key:0},[t("div",ee,[t("button",{class:"back-button",onClick:W},[...a[2]||(a[2]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15.75 19.5 8.25 12l7.5-7.5"})],-1)])]),t("span",null,"Nhắn tin với "+k(n.value.username||n.value.email),1)]),t("div",{class:"message-list",ref_key:"messageListEl",ref:m},[_.value?(i(),L(B,{key:0,message:"Đang tải lịch sử..."})):N("",!0),(i(!0),u(S,null,C(d.value,e=>(i(),u("div",{key:e.ID||e.timestamp,class:x(["message-item",M(v)&&e.senderId===M(v).id?"sent":"received"])},[t("div",se,k(e.content),1),t("div",ae,k(E(e.timestamp)),1)],2))),128))],512),t("div",te,[O(t("textarea",{class:"chat-input",placeholder:`Nhắn tin cho ${n.value.username}`,"onUpdate:modelValue":a[0]||(a[0]=e=>c.value=e),onKeydown:j(J(I,["prevent","exact"]),["enter"]),rows:"1",onInput:U,ref_key:"chatInputEl",ref:y},"                    ",40,ne),[[z,c.value]]),t("button",{class:"send-btn",onClick:I,disabled:!c.value.trim()},[...a[3]||(a[3]=[t("i",{class:"fa-solid fa-paper-plane"},null,-1)])],8,le)])],64)):N("",!0)])],2))}};export{re as default};
